<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jo Trent: Transport Manager - The Asia Edition</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom CSS for base styling and UI overlay */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #1A365D; /* Dark blue primary text */
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        .header {
            background-color: #1A365D; /* Trent's Drains dark blue */
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .accent-orange {
            color: #FF8C00;
        }
        .bg-accent-orange {
            background-color: #FF8C00;
        }
        .border-accent-orange {
            border-color: #FF8C00;
        }
        .trent-blue-light {
            background-color: #2A63AA;
        }
        .stats-bar {
            height: 1rem;
            border-radius: 9999px; /* Full rounded */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem; /* Rounded corners */
        }
        .flashing-phone {
            animation: flash 1s infinite alternate; /* Phone icon flash */
        }
        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.3; }
        }
        /* Custom button styling */
        .game-button {
            @apply bg-[#2A63AA] text-white px-4 py-2 rounded-lg shadow-lg hover:bg-[#1A365D] transition duration-300 ease-in-out font-bold;
        }
        .game-button:disabled {
            @apply bg-gray-400 cursor-not-allowed opacity-75;
        }
        /* Prominent Phone Button */
        .phone-button-ringing {
            animation: pulse-orange 1s infinite alternate;
            border: 3px solid #FF8C00;
            box-shadow: 0 0 15px #FF8C00;
        }
        @keyframes pulse-orange {
            from {
                box-shadow: 0 0 5px #FF8C00, 0 0 10px #FF8C00;
                transform: scale(1);
            }
            to {
                box-shadow: 0 0 20px #FF8C00, 0 0 40px #FF8C00;
                transform: scale(1.05);
            }
        }
        /* Start Screen */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #1A365D; /* Dark blue background */
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100; /* On top of everything */
            pointer-events: auto;
            text-align: center; /* Center text and image */
            padding: 1rem; /* Add some padding */
        }
        #startScreen h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem; /* Reduce margin to be closer to image/subtitle */
        }
        #startScreen .subtitle {
            font-size: 1.5rem; /* Make subtitle slightly smaller */
            margin-bottom: 1.5rem;
        }
        #startScreen button {
            padding: 1rem 2rem;
            font-size: 1.5rem;
            background-color: #FF8C00;
            color: white;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #startScreen button:hover {
            background-color: #e67e00;
        }
        /* Start screen image styling - REMOVED IMAGE */
        /*
        #startScreen img {
            max-width: 90%;
            height: auto;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        */

        /* 2D character SVGs - simplified */
        /* Retaining simplified SVGs for visual context where they are used */
        .character-svg {
            fill: #1A365D; /* Default fill */
            stroke: #2A63AA; /* Default stroke */
            stroke-width: 0.5;
        }
        .hoodie-svg {
            fill: #1A365D;
        }
        .dress-svg {
            fill: #FF8C00; /* Orange for Sam/Libby's attire */
        }
        .suit-svg {
            fill: #2A63AA;
        }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BGPRK91DD8"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-BGPRK91DD8');
    </script>
</head>
<body class="flex flex-col min-h-screen">
    <!-- Start Screen -->
    <div id="startScreen" style="display: flex;">
        <!-- Removed Start Screen Image -->
        <!-- <img src="image.png" alt="Jo Trent: Transport Manager - The Asia Edition Cover Art" class="mx-auto"> -->
        <h1 class="text-4xl md:text-6xl font-bold">Jo Trent: Transport Manager</h1>
        <p class="subtitle font-bold accent-orange">The Asia Edition</p>
        <button id="startGameBtn" class="game-button">Start Game</button>
    </div>

    <!-- Main Game UI (always visible once game starts) -->
    <main id="gameUI" class="flex-grow flex flex-col p-4 md:p-8 space-y-4 md:space-y-8" style="display: none;">
        <!-- Header -->
        <header class="header p-4 text-center">
            <h1 class="text-3xl font-bold">Jo Trent: Transport Manager</h1>
            <p class="text-sm">Trent's Drains: 24-hour drain unblocking since '92</p>
        </header>

        <!-- Main Content Area -->
        <div class="flex-grow flex flex-col md:flex-row gap-4 md:gap-8">

            <!-- Left Column: Stats & Office Interactions -->
            <div class="flex flex-col w-full md:w-1/2 space-y-4">
                <!-- Stats Display -->
                <div class="bg-white rounded-lg shadow-lg p-4 flex flex-col space-y-2">
                    <h2 class="text-xl font-bold">Stats</h2>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Time Left:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="timeLeftBar" class="bg-blue-500 h-full rounded-full transition-all duration-200" style="width: 100%;"></div>
                        </div>
                        <span id="timeLeftValue" class="w-12 text-right">0s</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Score:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="scoreBar" class="bg-green-500 h-full rounded-full transition-all duration-200" style="width: 50%;"></div>
                        </div>
                        <span id="scoreValue" class="w-12 text-right">0</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Boss Pressure:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="bossPressureBar" class="bg-red-500 h-full rounded-full transition-all duration-200" style="width: 0%;"></div>
                        </div>
                        <span id="bossPressureValue" class="w-12 text-right">0%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Sam Attention:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="samAttentionBar" class="bg-pink-400 h-full rounded-full transition-all duration-200" style="width: 0%;"></div>
                        </div>
                        <span id="samAttentionValue" class="w-12 text-right">0%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Libby Attention:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="libbyAttentionBar" class="bg-purple-400 h-full rounded-full transition-all duration-200" style="width: 0%;"></div>
                        </div>
                        <span id="libbyAttentionValue" class="w-12 text-right">0%</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="w-24 font-semibold">Asia Happiness:</span>
                        <div class="flex-grow bg-gray-200 rounded-full stats-bar">
                            <div id="asiaHappinessBar" class="bg-yellow-500 h-full rounded-full transition-all duration-200" style="width: 0%;"></div>
                        </div>
                        <span id="asiaHappinessValue" class="w-12 text-right">0%</span>
                    </div>
                </div>

                <!-- Office Environment (Static Background / Icons) - Removed complex SVGs, using placeholders or text -->
                <div class="bg-white rounded-lg shadow-lg p-4 relative flex-grow flex flex-col items-center justify-around">
                    <h3 class="text-xl font-bold absolute top-2 left-4">Jo's Office</h3>
                    <!-- Simplified character representations -->
                    <div class="flex flex-col items-center mb-4">
                        <p class="font-semibold text-xl">Jo Trent</p>
                        <p class="text-sm text-gray-600">(You! Busy working.)</p>
                    </div>
                    <div class="flex flex-col items-center mb-4">
                        <p class="font-semibold text-xl">Sam & Libby</p>
                        <p class="text-sm text-gray-600">(Office Colleagues)</p>
                    </div>
                    <div class="flex flex-col items-center">
                        <p class="font-semibold text-xl">Bosses (Lewis, Mark, Ross)</p>
                        <p class="text-sm text-gray-600">(Always Demanding)</p>
                    </div>
                </div>

                <!-- 2D Interaction Buttons -->
                <div class="bg-white rounded-lg shadow-lg p-4 flex flex-col space-y-4">
                    <h3 class="text-xl font-bold text-center">Office Interactions</h3>
                    <button id="answerPhoneBtn" class="game-button">Answer Phone</button>
                    <button id="talkToSamBtn" class="game-button">Talk to Sam</button>
                    <button id="talkToLibbyBtn" class="game-button">Talk to Libby</button>
                </div>
            </div>

            <!-- Right Column: Big Change System & Phone Status -->
            <div class="flex flex-col w-full md:w-1/2 space-y-4">
                <!-- Phone Status Icon -->
                <div class="bg-white rounded-lg shadow-lg p-4 text-center">
                    <h3 class="text-xl font-bold mb-2">Phone Status</h3>
                    <div id="phoneStatusIconContainer" class="mt-4 flex flex-col items-center">
                        <svg id="phoneStatusIcon" class="w-16 h-16 text-gray-500" viewBox="0 0 24 24" fill="currentColor">
                            <title>Phone Icon</title>
                            <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,19.58C15.77,19.94 16.27,20.08 16.72,19.99C17.75,19.78 18.9,19.66 20,19.66C20.55,19.66 21,20.11 21,20.66V23C21,23.55 20.55,24 20,24C10.61,24 3,16.39 3,7C3,6.45 3.45,6 4,6H6.34C6.89,6 7.34,6.45 7.34,7C7.34,8.1 7.22,9.25 7,10.28C6.91,10.73 7.06,11.23 7.42,11.59L9.62,13.79C10.05,14.22 10.05,14.92 9.62,15.35L7.42,17.55C6.85,18.12 6,18.42 5.12,18.42C4.19,18.42 3.29,18.06 2.59,17.36L2.34,17.11C1.65,16.42 1.3,15.52 1.3,14.61C1.3,13.73 1.6,12.86 2.19,12.03L2.44,11.78C3.06,11.08 3.5,10.25 3.5,9.41C3.5,8.42 2.76,7.5 1.76,7.5H1.3C0.75,7.5 0.3,7.95 0.3,8.5V9.41C0.3,10.3 0.65,11.19 1.34,11.89L1.59,12.14C2.28,12.83 3.18,13.18 4.09,13.18C5.06,13.18 5.92,12.82 6.62,12.12L6.87,11.87L6.62,10.79Z" />
                        </svg>
                        <p id="phoneStatusText" class="text-sm mt-1">Phone Status: Idle</p>
                    </div>
                </div>

                <!-- Big Change System -->
                <div class="bg-white rounded-lg shadow-lg p-4 flex flex-col flex-grow">
                    <h3 class="text-xl font-bold mb-4 text-center">The "Big Change" System</h3>
                    <div class="flex justify-center items-center mb-4">
                        <div class="w-32 h-32 rounded-full border-4 border-accent-orange overflow-hidden bg-gray-300 flex items-center justify-center">
                            <img src="https://placehold.co/128x128/FF8C00/FFFFFF?text=K.K." alt="Kevin Keegan" class="w-full h-full object-cover"/>
                        </div>
                    </div>

                    <div class="flex flex-col mb-4">
                        <h4 class="font-semibold mb-1">Engineers:</h4>
                        <div id="engineerList" class="flex flex-wrap gap-2">
                            <!-- Engineer buttons will be dynamically added here -->
                        </div>
                    </div>

                    <div class="flex flex-col mb-4 flex-grow">
                        <h4 class="font-semibold mb-1">Jobs:</h4>
                        <div id="jobList" class="flex flex-col gap-2 h-40 overflow-y-auto border border-gray-300 rounded-md p-2 bg-white flex-grow">
                            <!-- Job items will be dynamically added here -->
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-2 mt-auto">
                        <button id="assignJobBtn" class="game-button flex-grow" disabled>Assign Job</button>
                        <button id="clearSelectionBtn" class="game-button bg-gray-500 hover:bg-gray-600 flex-grow">Clear Selection</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modals (Initially Hidden) -->
    <!-- Generic Modal for all interactions -->
    <div id="genericModal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="modal-content w-full max-w-lg p-6 shadow-2xl flex flex-col space-y-4">
            <h3 id="modalTitle" class="text-2xl font-bold text-center accent-orange"></h3>
            <p id="modalMessage" class="text-lg text-center"></p>
            <div id="modalChoices" class="flex flex-col space-y-2">
                <!-- Choices will be dynamically added here -->
            </div>
            <button id="modalOkBtn" class="game-button" style="display:none;">OK</button>
        </div>
    </div>

    <!-- Nickname Input Modal -->
    <div id="nicknameModal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="modal-content w-full max-w-md p-6 shadow-2xl flex flex-col items-center space-y-4">
            <h3 class="text-2xl font-bold text-center accent-orange">Enter Your Nickname</h3>
            <p class="text-lg text-center">Your final scores:</p>
            <p class="text-md text-gray-700">Score: <span id="finalScoreNickname" class="font-bold"></span></p>
            <p class="text-md text-gray-700">Asia Happiness: <span id="finalAsiaNickname" class="font-bold"></span></p>
            <p class="text-md text-gray-700">Sam Attention: <span id="finalSamNickname" class="font-bold"></span></p>
            <p class="text-md text-gray-700">Libby Attention: <span id="finalLibbyNickname" class="font-bold"></span></p>
            <input type="text" id="nicknameInput" class="w-full p-2 border border-gray-300 rounded-md text-center" placeholder="Enter your nickname (e.g., JoFan123)" maxlength="15">
            <p id="nicknameError" class="text-red-500 text-sm" style="display: none;">Nickname cannot be empty.</p>
            <button id="submitNicknameBtn" class="game-button">Submit Score</button>
        </div>
    </div>

    <!-- Game Over and Leaderboard Modal -->
    <div id="gameOverModal" class="modal-overlay fixed inset-0 flex items-center justify-center p-4 z-50" style="display: none;">
        <div class="modal-content w-full max-w-2xl p-6 shadow-2xl flex flex-col space-y-4">
            <h3 id="gameOverTitle" class="text-3xl font-bold text-red-600 text-center"></h3>
            <p id="gameOverMessage" class="text-xl text-center"></p>
            <h4 class="text-2xl font-bold text-center accent-orange mt-4">Leaderboard</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-100 border-b border-gray-200">
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="score">Rank</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="username">Player</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="score">Score</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="asiaScore">Asia</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="samScore">Sam</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="libbyScore">Libby</th>
                            <th class="px-4 py-2 text-left font-semibold cursor-pointer" data-sort="timestamp">Date</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <!-- Leaderboard entries will be loaded here -->
                    </tbody>
                </table>
            </div>
            <button id="restartGameBtn" class="game-button bg-green-600 hover:bg-green-700 mt-4">Play Again</button>
        </div>
    </div>

    <!-- Firebase SDK (latest modular version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global Firebase variables accessible by game logic
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.currentUserId = null;
        window.appId = null; // Will be set by Canvas environment

        const initFirebase = async () => {
            try {
                window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-jo-trent-game';
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

                if (Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config not found. Firestore will not be available. Please provide __firebase_config.");
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUserId = user.uid;
                        console.log("Firebase: Signed in as user:", user.uid);
                        // Once authenticated, load leaderboard
                        if (window.leaderboardInitialized && window.elements && window.elements.gameOverModal.style.display === 'flex') {
                            // Check if game over modal is already visible, then display leaderboard
                            window.displayLeaderboard();
                        }
                    } else {
                        console.log("Firebase: No user signed in. Attempting anonymous sign-in...");
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(window.auth, __initial_auth_token);
                                console.log("Firebase: Signed in with custom token.");
                            } else {
                                await signInAnonymously(window.auth);
                                console.log("Firebase: Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            window.currentUserId = crypto.randomUUID(); // Fallback to random ID if auth fails
                            console.warn("Using a random ID for user due to authentication failure. Leaderboard might not be persistent across sessions.");
                            // Still attempt to load leaderboard even if anonymous sign-in failed, using random ID
                            if (window.leaderboardInitialized && window.elements && window.elements.gameOverModal.style.display === 'flex') {
                                window.displayLeaderboard();
                            }
                        }
                    }
                });
            } catch (e) {
                console.error("Failed to initialize Firebase:", e);
            }
        };

        // Make Firestore functions globally accessible through window
        window.saveScoreToFirestore = async (username, scoreData) => {
            if (!window.db || !window.currentUserId || !window.appId) {
                console.warn("Firestore not initialized or user not logged in. Cannot save score.");
                return;
            }

            try {
                await addDoc(collection(window.db, "artifacts", window.appId, "public", "data", "leaderboard"), {
                    userId: window.currentUserId,
                    username: username,
                    score: scoreData.score,
                    asiaScore: scoreData.asiaScore,
                    samScore: scoreData.samScore,
                    libbyScore: scoreData.libbyScore,
                    timestamp: new Date()
                });
                console.log("Score saved to Firestore.");
            } catch (e) {
                console.error("Error saving score to Firestore:", e);
            }
        };

        window.displayLeaderboard = () => {
            if (!window.db || !window.appId) {
                console.warn("Firestore not initialized. Cannot display leaderboard.");
                return;
            }

            const leaderboardQuery = query(
                collection(window.db, "artifacts", window.appId, "public", "data", "leaderboard"),
                orderBy("score", "desc"),
                limit(10)
            );

            // Use onSnapshot for real-time updates
            onSnapshot(leaderboardQuery, (snapshot) => {
                const leaderboardBody = window.elements.leaderboardBody;
                if (!leaderboardBody) {
                    console.warn("Leaderboard body element not found.");
                    return;
                }
                leaderboardBody.innerHTML = ''; // Clear existing entries
                let rank = 1;
                if (snapshot.empty) {
                    leaderboardBody.innerHTML = `<tr><td colspan="7" class="px-4 py-2 text-center text-gray-500">No scores yet! Be the first!</td></tr>`;
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const row = `
                            <tr>
                                <td class="px-4 py-2 border-b border-gray-200">${rank++}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.username}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.score}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.asiaScore}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.samScore}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.libbyScore}</td>
                                <td class="px-4 py-2 border-b border-gray-200">${data.timestamp ? new Date(data.timestamp.toDate()).toLocaleDateString() : 'N/A'}</td>
                            </tr>
                        `;
                        leaderboardBody.insertAdjacentHTML('beforeend', row);
                    });
                }
                console.log("Leaderboard updated from Firestore.");
            }, (error) => {
                console.error("Error fetching leaderboard:", error);
                const leaderboardBody = window.elements.leaderboardBody;
                if (leaderboardBody) {
                    leaderboardBody.innerHTML = `<tr><td colspan="7" class="px-4 py-2 text-center text-red-500">Error loading leaderboard.</td></tr>`;
                }
            });
        };

        // Initialize Firebase when DOM is ready
        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
    <script>
        // --- Game State Variables ---
        let timeLeft = 180; // Game duration in seconds
        let score = 0;
        let bossPressure = 0; // 0-100%
        let samAttention = 0; // 0-100%
        let libbyAttention = 0; // 0-100%
        let asiaHappiness = 50; // 0-100%

        let gameRunning = false;
        let isModalOpen = false; // Flag to prevent interruptions during modals

        let selectedEngineer = null;
        let selectedJob = null;

        let lastCallTime = 0;
        let lastJobAppearanceTime = 0;

        // Guaranteed call counters
        let asiaCallsMade = 0;
        const ASIA_CALLS_GUARANTEED = 4;
        let henrykCallsMade = 0;
        const HENRYK_CALLS_GUARANTEED = 1;

        // Track last caller type to avoid immediate repetition
        let lastCallerType = null;
        let consecutiveCallerCount = 0;


        // --- Audio Elements ---
        // Placeholder objects, no actual audio playback functionality here
        // All audio is removed to fix "NotSupportedError: The element has no supported sources."
        // If re-introducing audio, ensure you use reliably hosted MP3 files or integrate Tone.js for web audio.
        const audio = {
            mainGameMusic: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            urgentMusic: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            sexyMusic: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            personalCallMusic: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            buttonClick: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            phoneRing: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            goodReaction: { play: () => {}, pause: () => {}, currentTime: 0, loop: false },
            badReaction: { play: () => {}, pause: () => {}, currentTime: 0, loop: false }
        };


        // --- DOM Elements ---
        let elements = {};

        document.addEventListener('DOMContentLoaded', () => {
            elements = {
                startScreen: document.getElementById('startScreen'),
                startGameBtn: document.getElementById('startGameBtn'),
                gameUI: document.getElementById('gameUI'), // Main game UI container
                timeLeftBar: document.getElementById('timeLeftBar'),
                timeLeftValue: document.getElementById('timeLeftValue'),
                scoreBar: document.getElementById('scoreBar'),
                scoreValue: document.getElementById('scoreValue'),
                bossPressureBar: document.getElementById('bossPressureBar'),
                bossPressureValue: document.getElementById('bossPressureValue'),
                samAttentionBar: document.getElementById('samAttentionBar'),
                samAttentionValue: document.getElementById('samAttentionValue'),
                libbyAttentionBar: document.getElementById('libbyAttentionBar'),
                libbyAttentionValue: document.getElementById('libbyAttentionValue'),
                asiaHappinessBar: document.getElementById('asiaHappinessBar'),
                asiaHappinessValue: document.getElementById('asiaHappinessValue'),
                phoneStatusIconContainer: document.getElementById('phoneStatusIconContainer'),
                phoneStatusIcon: document.getElementById('phoneStatusIcon'),
                phoneStatusText: document.getElementById('phoneStatusText'),
                answerPhoneBtn: document.getElementById('answerPhoneBtn'), // 2D Button
                talkToSamBtn: document.getElementById('talkToSamBtn'),   // 2D Button
                talkToLibbyBtn: document.getElementById('talkToLibbyBtn'), // 2D Button
                assignJobBtn: document.getElementById('assignJobBtn'),
                clearSelectionBtn: document.getElementById('clearSelectionBtn'),
                engineerList: document.getElementById('engineerList'),
                jobList: document.getElementById('jobList'),
                genericModal: document.getElementById('genericModal'),
                modalTitle: document.getElementById('modalTitle'),
                modalMessage: document.getElementById('modalMessage'),
                modalChoices: document.getElementById('modalChoices'),
                modalOkBtn: document.getElementById('modalOkBtn'),
                nicknameModal: document.getElementById('nicknameModal'), // New nickname modal
                nicknameInput: document.getElementById('nicknameInput'),
                nicknameError: document.getElementById('nicknameError'),
                submitNicknameBtn: document.getElementById('submitNicknameBtn'),
                finalScoreNickname: document.getElementById('finalScoreNickname'),
                finalAsiaNickname: document.getElementById('finalAsiaNickname'),
                finalSamNickname: document.getElementById('finalSamNickname'),
                finalLibbyNickname: document.getElementById('finalLibbyNickname'),
                gameOverModal: document.getElementById('gameOverModal'),
                gameOverTitle: document.getElementById('gameOverTitle'),
                gameOverMessage: document.getElementById('gameOverMessage'),
                finalScore: document.getElementById('finalScore'),
                restartGameBtn: document.getElementById('restartGameBtn'),
                leaderboardBody: document.getElementById('leaderboardBody') // Leaderboard table body
            };

            // Expose elements to global scope for Firebase script access
            window.elements = elements;

            // Attach event listeners
            if (elements.startGameBtn) {
                elements.startGameBtn.addEventListener('click', handleStartGameClick);
            } else {
                console.error("Start Game button not found!");
            }
            if (elements.restartGameBtn) {
                elements.restartGameBtn.addEventListener('click', restartGame);
            }
            if (elements.answerPhoneBtn) elements.answerPhoneBtn.addEventListener('click', answerPhone);
            if (elements.talkToSamBtn) elements.talkToSamBtn.addEventListener('click', talkToSam);
            if (elements.talkToLibbyBtn) elements.talkToLibbyBtn.addEventListener('click', talkToLibby);
            if (elements.assignJobBtn) elements.assignJobBtn.addEventListener('click', assignJob);
            if (elements.clearSelectionBtn) elements.clearSelectionBtn.addEventListener('click', clearSelection);
            if (elements.submitNicknameBtn) elements.submitNicknameBtn.addEventListener('click', submitNickname);


            updateUI(); // Initial UI update
        });

        // --- Game Data: Scenarios, Engineers, etc. ---
        const engineers = [
            { id: 'engineer-jordan', name: 'Jordan', isAvailable: true, currentJobId: null, type: 'difficult' },
            { id: 'engineer-calum', name: 'Calum', isAvailable: true, currentJobId: null, type: 'nephew' },
            { id: 'engineer-dave', name: 'Dave', isAvailable: true, currentJobId: null, type: 'normal' },
            { id: 'engineer-sarah', name: 'Sarah', isAvailable: true, currentJobId: null, type: 'normal' },
        ];

        let jobs = []; // Active jobs in the queue
        let jobCounter = 0; // To give unique IDs to jobs

        const callScenarios = {
            boss: shuffleArray([
                { id: 'boss-1', caller: 'Lewis Trent (Big Boss)', message: 'Jo, I need that Cater Road blockage sorted ASAP. Reputations on the line!', choices: [{ text: 'Acknowledge immediately', outcome: 'Lewis nods approvingly. "Good. Get it done."', effect: { score: 10, bossPressure: -5 } }, { text: 'Ask for more details (time consuming)', outcome: 'Lewis sighs. "Just deal with it, Jo. Find out yourself."', effect: { score: -5, bossPressure: 10, timeLeft: -5 } }, ] },
                { id: 'boss-2', caller: 'Mark Trent (Big Boss)', message: 'Jo, profitability report is due. Where are we on efficiency targets for this week?', choices: [{ text: 'Confirm targets are on track', outcome: 'Mark grunts. "Keep it up, Jo."', effect: { score: 10, bossPressure: -5 } }, { text: 'Admit slight delay', outcome: 'Mark\'s tone hardens. "This is unacceptable, Jo. Get it sorted."', effect: { score: -10, bossPressure: 15 } }, ] },
                { id: 'boss-3', caller: 'Ross (Direct Boss)', message: 'Jo! The High Street job has been sitting for an hour! What\'s going on?', choices: [{ text: 'Apologize and promise immediate action', outcome: 'Ross sounds mollified. "See that you do."', effect: { score: 5, bossPressure: -10 } }, { text: 'Blame engineer availability', outcome: 'Ross barks, "Excuses, Jo! Find a solution!"', effect: { score: -15, bossPressure: 20 } }, ] },
                { id: 'boss-4', caller: 'Lewis Trent (Big Boss)', message: 'We have a VIP client complaint. They say our engineer was rude. Address this immediately.', choices: [{ text: 'Assure swift resolution and apology', outcome: 'Lewis states, "Good. Make sure it never happens again."', effect: { score: 15, bossPressure: -10 } }, { text: 'Defend the engineer (risky)', outcome: 'Lewis explodes, "Are you undermining me, Jo?!"', effect: { score: -20, bossPressure: 30 } }, ] },
                { id: 'boss-5', caller: 'Mark Trent (Big Boss)', message: 'The new drainage system has a major bug. What\'s the estimated fix time?', choices: [{ text: 'Provide a confident, realistic estimate', outcome: 'Mark sounds relieved. "Keep me updated."', effect: { score: 10, bossPressure: -5 } }, { text: 'Admit you haven\'t looked at it yet', outcome: 'Mark fumes. "You need to be on top of this, Jo!"', effect: { score: -10, bossPressure: 15, timeLeft: -5 } }, ] }
            ]),
            hr: shuffleArray([
                { id: 'hr-1', caller: 'Mark Trent (HR)', message: 'Jo, Megan Friday\'s performance is slipping. It\'s time to let her go. Can you handle the termination paperwork?', choices: [{ text: 'Agree to process termination (tough but efficient)', outcome: 'Mark: "Good. No sentimentality in business."', effect: { score: 10, bossPressure: -10, asiaHappiness: -5 } }, { text: 'Suggest a performance improvement plan (risky)', outcome: 'Mark: "Jo, we don\'t have time for hand-holding. This is a business decision."', effect: { score: -15, bossPressure: 20, asiaHappiness: 5 } }, ] },
                { id: 'hr-2', caller: 'Lewis Trent (HR)', message: 'Kirsty\'s wages are too high for her output. I need you to inform her of a significant pay cut. Can you do it today?', choices: [{ text: 'Proceed with the pay cut (unpopular)', outcome: 'Lewis: "Excellent. Cost-cutting is crucial."', effect: { score: 10, bossPressure: -10, asiaHappiness: -10 } }, { text: 'Refuse, citing morale concerns (very risky)', outcome: 'Lewis: "Jo, your job is to implement decisions, not question them."', effect: { score: -25, bossPressure: 35, asiaHappiness: 10 } }, ] },
                { id: 'hr-3', caller: 'Ross (HR)', message: 'One of our new hires, Tom, is failing his probation period. He\'s constantly late. Officially fail him?', choices: [{ text: 'Fail him immediately', outcome: 'Ross: "Good. We need reliable staff."', effect: { score: 5, bossPressure: -5 } }, { text: 'Give him one last chance', outcome: 'Ross: "Hope you know what you\'re doing, Jo. My neck\'s on the line too."', effect: { score: -10, bossPressure: 10 } }, ] }
            ]),
            asia: shuffleArray([
                { id: 'asia-1', caller: 'Asia (Wife)', message: 'Hi honey, could you pick up some groceries on your way home? Just milk and bread.', choices: [{ text: 'Of course, no problem!', outcome: 'Asia: "You\'re the best! Love you!"', effect: { score: 5, asiaHappiness: 10, timeLeft: -5 } }, { text: 'I\'m really busy, maybe later.', outcome: 'Asia: "Oh. Okay. I guess I\'ll manage."', effect: { score: -5, asiaHappiness: -10, bossPressure: 5 } }, ] },
                { id: 'asia-2', caller: 'Asia (Wife)', message: 'Did you remember to take out the bins this morning? It\'s bin day!', choices: [{ text: 'Yes, all done!', outcome: 'Asia: "Phew! You\'re a lifesaver."', effect: { score: 5, asiaHappiness: 10 } }, { text: 'Oh no, I forgot!', outcome: 'Asia: "Jo! Now we\'ll have to wait two weeks!"', effect: { score: -10, asiaHappiness: -15, bossPressure: 5 } }, ] },
                { id: 'asia-3', caller: 'Asia (Wife)', message: 'I really need some wine for tonight, and maybe some chocolate. Can you grab them?', choices: [{ text: 'On it!', outcome: 'Asia: "My hero! See you soon."', effect: { score: 10, asiaHappiness: 15, timeLeft: -10 } }, { text: 'I\'m too swamped at work.', outcome: 'Asia: "Seriously, Jo? It\'s just a quick stop."', effect: { score: -10, asiaHappiness: -20, bossPressure: 10 } }, ] },
                { id: 'asia-4', caller: 'Asia (Wife)', message: 'Henryk has soccer practice, can you pick him up from school today?', choices: [{ text: 'Sure, I can manage that.', outcome: 'Asia: "Thanks, I owe you big time!"', effect: { score: 10, asiaHappiness: 15, timeLeft: -15 } }, { text: 'I can\'t, too many jobs to assign.', outcome: 'Asia: "Ugh, fine. I\'ll rearrange my day."', effect: { score: -15, asiaHappiness: -25, bossPressure: 15 } }, ] },
                { id: 'asia-5', caller: 'Asia (Wife)', message: 'The dry cleaning is ready, can you grab it after work?', choices: [{ text: 'Will do!', outcome: 'Asia: "Perfect, thanks darling."', effect: { score: 5, asiaHappiness: 10, timeLeft: -5 } }, { text: 'That\'s out of my way today.', outcome: 'Asia: "Honestly, Jo, sometimes you\'re impossible."', effect: { score: -5, asiaHappiness: -10, bossPressure: 5 } }, ] },
                { id: 'asia-6', caller: 'Asia (Wife)', message: 'The dishes are piling up. Will you load the dishwasher when you get home?', choices: [{ text: 'Already planned on it!', outcome: 'Asia: "You read my mind! Amazing."', effect: { score: 5, asiaHappiness: 10 } }, { text: 'I\'m exhausted, can\'t it wait?', outcome: 'Asia: "No, it can\'t. I do everything else."', effect: { score: -10, asiaHappiness: -15, bossPressure: 5 } }, ] }
            ]),
            henryk: shuffleArray([
                { id: 'henryk-1', caller: 'School (Henryk)', message: 'Mr. Trent, Henryk was throwing crayons at other students today. We need you to come discuss his behavior.', choices: [{ text: 'Express immediate concern and promise to visit', outcome: 'School: "Thank you, Mr. Trent. We appreciate your cooperation."', effect: { score: 10, bossPressure: 10, asiaHappiness: -10, timeLeft: -15 } }, { text: 'Downplay it as childish antics', outcome: 'School: "This is a serious matter, Mr. Trent. We expect more from you."', effect: { score: -15, bossPressure: 20, asiaHappiness: -20 } }, ] },
                { id: 'henryk-2', caller: 'School (Henryk)', message: 'Mr. Trent, Henryk talked back to his teacher during class. He needs to understand respect.', choices: [{ text: 'Assure them you\'ll have a serious talk with him', outcome: 'School: "We appreciate your commitment, Mr. Trent."', effect: { score: 5, bossPressure: 5, asiaHappiness: -5 } }, { text: 'Suggest the teacher might be too strict', outcome: 'School: "Mr. Trent, we follow a clear disciplinary policy."', effect: { score: -10, bossPressure: 15, asiaHappiness: -15 } }, ] },
                { id: 'henryk-3', caller: 'School (Henryk)', message: 'Mr. Trent, Henryk refused to eat his lunch today. He\'s been very disruptive.', choices: [{ text: 'Apologize and promise to talk to him about nutrition', outcome: 'School: "Thank you for your understanding."', effect: { score: 5, bossPressure: 5, asiaHappiness: -5 } }, { text: 'Blame the school\'s menu', outcome: 'School: "We provide balanced meals, Mr. Trent. This is a behavioral issue."', effect: { score: -10, bossPressure: 15, asiaHappiness: -15 } }, ] },
                { id: 'henryk-4', caller: 'School (Henryk)', message: 'Mr. Trent, Henryk was running in the halls and almost caused an accident. We need to address this.', choices: [{ text: 'Promise to reinforce school rules at home', outcome: 'School: "Excellent, Mr. Trent. We need him to understand safety."', effect: { score: 5, bossPressure: 5, asiaHappiness: -5 } }, { text: 'Say he\'s just being energetic', outcome: 'School: "His energy needs to be channeled appropriately, Mr. Trent."', effect: { score: -10, bossPressure: 15, asiaHappiness: -15 } }, ] }
            ]),
        };

        const officeScenarios = {
            sam: shuffleArray([
                { id: 'sam-1', message: 'Hey Jo, this printer is being a nightmare. Any ideas?', choices: [{ text: 'Offer to take a look (helpful)', outcome: 'Sam: "You\'re a lifesaver, Jo!"', effect: { samAttention: 10, timeLeft: -5 } }, { text: 'Suggest calling IT (unhelpful)', outcome: 'Sam: "Oh, right. I guess."', effect: { samAttention: -5, bossPressure: 2 } }, ] },
                { id: 'sam-2', message: 'Ugh, Monday blues hitting hard today. Need more coffee!', choices: [{ text: 'Sympathize and offer to make coffee', outcome: 'Sam: "You get me, Jo!"', effect: { samAttention: 15, timeLeft: -5 } }, { text: 'Tell her to snap out of it (awkward)', outcome: 'Sam: "Well, aren\'t you a ray of sunshine."', effect: { samAttention: -10, bossPressure: 5 } }, ] },
                { id: 'sam-3', message: 'This spreadsheet is baffling me. What\'s a VLOOKUP again?', choices: [{ text: 'Patiently explain it (helpful)', outcome: 'Sam: "Wow, you\'re smart, Jo! Thanks!"', effect: { samAttention: 10, timeLeft: -10 } }, { text: 'Pretend you don\'t know (unhelpful)', outcome: 'Sam: "Never mind, I\'ll ask someone else."', effect: { samAttention: -5, bossPressure: 2 } }, ] },
                { id: 'sam-4', message: 'Brr, it\'s chilly in here today.', choices: [{ text: 'Offer her your hoodie (flirtatious)', outcome: 'Sam blushes. "Oh, Jo! You\'re too kind."', effect: { samAttention: 20, timeLeft: -2, bossPressure: 3 } }, { text: 'Suggest she put on a jacket (practical)', outcome: 'Sam: "Yeah, I guess."', effect: { samAttention: 0 } }, ] },
                { id: 'sam-5', message: 'Thinking of grabbing coffee. Want to join?', choices: [{ text: 'Definitely! (enthusiastic)', outcome: 'Sam smiles. "Great! Let\'s go."', effect: { samAttention: 25, timeLeft: -10, bossPressure: 5 } }, { text: 'Can\'t, too busy. (work-focused)', outcome: 'Sam looks disappointed. "Okay, another time."', effect: { samAttention: -15, bossPressure: -5 } }, ] },
                { id: 'sam-6', message: 'My car\'s making a weird noise. Any idea what it could be?', choices: [{ text: 'Offer advice, share car tips', outcome: 'Sam: "You know so much, Jo!"', effect: { samAttention: 10, timeLeft: -5 } }, { text: 'Tell her to take it to a garage', outcome: 'Sam: "Yeah, obviously."', effect: { samAttention: -5, bossPressure: 2 } }, ] }
            ]),
            libby: shuffleArray([
                { id: 'libby-1', message: 'My computer is so sluggish today. Driving me nuts!', choices: [{ text: 'Offer to optimize it for her (helpful)', outcome: 'Libby: "You\'re a lifesaver, Jo! Thanks!"', effect: { libbyAttention: 10, timeLeft: -5 } }, { text: 'Suggest restarting it (basic advice)', outcome: 'Libby: "Already tried that, but thanks."', effect: { libbyAttention: -5, bossPressure: 2 } }, ] },
                { id: 'libby-2', message: 'Lunch plans? I\'m starving.', choices: [{ text: 'Suggest lunch together (flirtatious)', outcome: 'Libby smiles. "Sounds good! My treat."', effect: { libbyAttention: 20, timeLeft: -10, bossPressure: 5 } }, { text: 'Suggest a local spot (friendly)', outcome: 'Libby: "Good idea, I\'ll check it out."', effect: { libbyAttention: 5 } }, ] },
                { id: 'libby-3', message: 'This office drama is exhausting. What\'s your take?', choices: [{ text: 'Agree and offer a sympathetic ear', outcome: 'Libby: "Right? Glad someone else sees it."', effect: { libbyAttention: 10, timeLeft: -5 } }, { text: 'Tell her to ignore it (dismissive)', outcome: 'Libby: "Easy for you to say."', effect: { libbyAttention: -10, bossPressure: 5 } }, ] },
                { id: 'libby-4', message: 'Lewis\'s Ferrari is ridiculous, isn\'t it?', choices: [{ text: 'Agree and joke about it (relatable)', outcome: 'Libby laughs. "Exactly! Good to know I\'m not the only one."', effect: { libbyAttention: 15 } }, { text: 'Defend Lewis (awkward)', outcome: 'Libby looks surprised. "Oh. Okay."', effect: { libbyAttention: -5, bossPressure: 2 } }, ] },
                { id: 'libby-5', message: 'Any exciting weekend plans?', choices: [{ text: 'Share interesting plans, maybe invite her (flirtatious)', outcome: 'Libby: "Oh, that sounds fun! Maybe next time."', effect: { libbyAttention: 20 } }, { text: 'Keep it vague, focus on work (unengaging)', outcome: 'Libby: "Ah, right. Busy, busy."', effect: { libbyAttention: -5 } }, ] },
                { id: 'libby-6', message: 'This new software is so confusing. Can you help me navigate it?', choices: [{ text: 'Offer detailed assistance (helpful)', outcome: 'Libby: "You\'re a wizard, Jo! Thanks!"', effect: { libbyAttention: 10, timeLeft: -10 } }, { text: 'Say you\'re still learning it too', outcome: 'Libby: "Fair enough, I guess."', effect: { libbyAttention: -5, bossPressure: 2 } }, ] }
            ]),
        };

        // Track used scenarios for uniqueness
        let usedSamScenarios = new Set();
        let usedLibbyScenarios = new Set();
        let usedAsiaScenarios = new Set();
        let usedHenrykScenarios = new Set();
        let usedBossScenarios = new Set();
        let usedHRScenarios = new Set();

        // --- Utility Functions ---

        /**
         * Shuffles an array in place.
         * @param {Array} array The array to shuffle.
         * @returns {Array} The shuffled array.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Gets a random integer between min (inclusive) and max (inclusive).
         * @param {number} min
         * @param {number} max
         * @returns {number}
         */
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        /**
         * Plays a specific audio track with error handling.
         * @param {object} track - The audio track object (now a placeholder with no-op play).
         */
        function playSound(track) {
            // All audio functionality removed due to persistent errors.
            // This function now does nothing.
            // console.log(`Attempted to play sound: ${track.name || 'unknown'}`);
        }


        /**
         * Updates the UI elements based on current game state.
         */
        function updateUI() {
            // Check if elements are initialized before trying to access properties
            if (!elements || !elements.timeLeftBar) {
                console.warn("UI elements not yet initialized during updateUI call.");
                return;
            }

            // Update stats bars and values, ensuring they stay within 0-100% or appropriate bounds
            score = Math.max(0, score); // Score cannot go below 0
            bossPressure = Math.min(100, Math.max(0, bossPressure));
            samAttention = Math.min(100, Math.max(0, samAttention));
            libbyAttention = Math.min(100, Math.max(0, libbyAttention));
            asiaHappiness = Math.min(100, Math.max(0, asiaHappiness));

            elements.timeLeftBar.style.width = `${(timeLeft / 180) * 100}%`;
            elements.timeLeftValue.textContent = `${timeLeft}s`;
            elements.scoreBar.style.width = `${(score / 1000) * 100}%`; // Assuming max score of 1000 for bar visualization
            elements.scoreValue.textContent = score;
            elements.bossPressureBar.style.width = `${bossPressure}%`;
            elements.bossPressureValue.textContent = `${bossPressure}%`;
            elements.samAttentionBar.style.width = `${samAttention}%`;
            elements.samAttentionValue.textContent = `${samAttention}%`;
            elements.libbyAttentionBar.style.width = `${libbyAttention}%`;
            elements.libbyAttentionValue.textContent = `${libbyAttention}%`;
            elements.asiaHappinessBar.style.width = `${asiaHappiness}%`;
            elements.asiaHappinessValue.textContent = `${asiaHappiness}%`;

            // Update button states for 2D UI
            elements.assignJobBtn.disabled = !gameRunning || selectedEngineer === null || selectedJob === null || isModalOpen;
            elements.clearSelectionBtn.disabled = !gameRunning || (selectedEngineer === null && selectedJob === null) || isModalOpen;
            elements.answerPhoneBtn.disabled = !gameRunning || elements.phoneIcon3D.flashing !== true || isModalOpen; // Only active when phone is ringing
            elements.talkToSamBtn.disabled = !gameRunning || isModalOpen;
            elements.talkToLibbyBtn.disabled = !gameRunning || isModalOpen;


            // Update phone status icon and button based on 3D phone's flashing state
            // In 2D, phoneIcon3D is just a flag we manually set/unset
            if (elements.phoneStatusIcon) { // Ensure the 2D icon exists
                if (elements.phoneIcon3D.flashing) {
                    elements.phoneStatusIcon.classList.add('flashing-phone');
                    elements.phoneStatusText.textContent = 'Phone Status: RINGING!';
                    elements.phoneStatusText.classList.add('text-red-500');
                    elements.answerPhoneBtn.classList.add('phone-button-ringing'); // Add prominent class
                } else {
                    elements.phoneStatusIcon.classList.remove('flashing-phone');
                    elements.phoneStatusText.textContent = 'Phone Status: Idle';
                    elements.phoneStatusText.classList.remove('text-red-500');
                    elements.answerPhoneBtn.classList.remove('phone-button-ringing'); // Remove prominent class
                }
            }


            // Render engineers
            elements.engineerList.innerHTML = engineers.map(eng => `
                <button id="${eng.id}" class="engineer-btn flex flex-col items-center p-2 rounded-lg border border-gray-300 ${eng.isAvailable ? 'bg-green-100 hover:bg-green-200' : 'bg-red-100 opacity-70 cursor-not-allowed'} ${selectedEngineer === eng.id ? 'border-2 border-accent-orange ring-2 ring-accent-orange' : ''}" data-engineer-id="${eng.id}" ${!eng.isAvailable || isModalOpen ? 'disabled' : ''}>
                    <svg class="w-10 h-10 text-gray-700" viewBox="0 0 100 100" fill="currentColor">
                        <title>${eng.name}</title>
                        <circle cx="50" cy="30" r="20" fill="#f8d8b4" stroke="#8b4513" stroke-width="2"/>
                        <rect x="25" y="45" width="50" height="45" rx="8" ry="8" fill="#1A365D"/>
                        <line x1="40" y1="50" x2="40" y2="60" stroke="white" stroke-width="2"/>
                        <line x1="60" y1="50" x2="60" y2="60" stroke="white" stroke-width="2"/>
                        <circle cx="43" cy="30" r="2" fill="black"/>
                        <circle cx="57" cy="30" r="2" fill="black"/>
                        <path d="M 45 37 Q 50 40, 55 37" stroke="black" stroke-width="1.5" fill="none"/>
                    </svg>
                    <span class="font-semibold text-sm mt-1">${eng.name}</span>
                    <span class="text-xs ${eng.isAvailable ? 'text-green-700' : 'text-red-700'}">${eng.isAvailable ? 'Available' : 'Busy'}</span>
                </button>
            `).join('');

            // Render jobs
            elements.jobList.innerHTML = jobs.map(job => `
                <button id="${job.id}" class="job-btn p-3 rounded-lg border flex flex-col text-left ${job.isOverdue ? 'bg-red-200 border-red-500' : 'bg-blue-100 border-blue-300 hover:bg-blue-200'} ${selectedJob === job.id ? 'border-2 border-accent-orange ring-2 ring-accent-orange' : ''}" data-job-id="${job.id}" ${isModalOpen ? 'disabled' : ''}>
                    <span class="font-semibold">${job.name}</span>
                    <span class="text-sm text-gray-600">Due: ${job.timer}s</span>
                    ${job.isOverdue ? '<span class="text-red-700 font-bold">OVERDUE!</span>' : ''}
                </button>
            `).join('');

            // Add event listeners to dynamically created buttons
            document.querySelectorAll('.engineer-btn').forEach(button => {
                button.onclick = () => {
                    // No audio click sound now
                    selectedEngineer = button.dataset.engineerId;
                    updateUI();
                };
            });
            document.querySelectorAll('.job-btn').forEach(button => {
                button.onclick = () => {
                    // No audio click sound now
                    selectedJob = button.dataset.jobId;
                    updateUI();
                };
            });
        }

        /**
         * Applies an effect to game stats.
         * @param {object} effect - Object with stat changes (e.g., { score: 10, bossPressure: -5 })
         */
        function applyEffect(effect) {
            const initialScore = score; // Capture score before applying
            const initialBossPressure = bossPressure;
            const initialSamAttention = samAttention;
            const initialLibbyAttention = libbyAttention;
            const initialAsiaHappiness = asiaHappiness;

            if (effect.score) score += effect.score;
            if (effect.bossPressure) bossPressure += effect.bossPressure;
            if (effect.samAttention) samAttention += effect.samAttention;
            if (effect.libbyAttention) libbyAttention += effect.libbyAttention;
            if (effect.asiaHappiness) asiaHappiness += effect.asiaHappiness;
            if (effect.timeLeft) timeLeft += effect.timeLeft;

            // Determine if overall effect was positive or negative for sound feedback
            let netEffect = 0;
            if (effect.score !== undefined) netEffect += effect.score;
            if (effect.bossPressure !== undefined) netEffect -= (effect.bossPressure * 2); // Pressure is negative impact
            if (effect.samAttention !== undefined) netEffect += effect.samAttention;
            if (effect.libbyAttention !== undefined) netEffect += effect.libbyAttention;
            if (effect.asiaHappiness !== undefined) netEffect += effect.asiaHappiness;
            // Time cost is inherently negative, but not necessarily a "reaction" sound
            // if (effect.timeLeft !== undefined) netEffect -= (effect.timeLeft * 0.5);

            // No audio for good/bad reaction now
            // if (netEffect > 0) {
            //     playSound(audio.goodReaction);
            // } else if (netEffect < 0) {
            //     playSound(audio.badReaction);
            // }

            updateUI();
        }

        /**
         * Displays a modal with messages and choices or an OK button.
         * @param {string} title
         * @param {string} message
         * @param {Array<object>} choices (optional) - Array of { text, effect, outcome }
         * @param {function} onOk (optional) - Callback for OK button click
         */
        function showModal(title, message, choices = null, onOk = null) {
            isModalOpen = true; // Set flag
            elements.modalTitle.textContent = title;
            elements.modalMessage.textContent = message;
            elements.modalChoices.innerHTML = '';
            elements.modalOkBtn.style.display = 'none';

            if (choices && choices.length > 0) {
                choices.forEach(choice => {
                    const choiceBtn = document.createElement('button');
                    choiceBtn.className = 'game-button w-full';
                    choiceBtn.textContent = choice.text;
                    choiceBtn.onclick = () => {
                        // No audio click sound now
                        hideModal(); // Hide the current modal
                        // Show outcome modal immediately
                        // Pass a flag to indicate if this is the final outcome modal of an interaction
                        showModal('Outcome', choice.outcome, null, () => {
                            applyEffect(choice.effect); // Apply effects and play reaction sound
                            onModalClose(); // Final clean up after outcome
                        });
                    };
                    elements.modalChoices.appendChild(choiceBtn);
                });
            } else {
                elements.modalOkBtn.style.display = 'block';
                elements.modalOkBtn.onclick = () => {
                    // No audio click sound now
                    hideModal();
                    if (onOk) onOk();
                };
            }
            elements.genericModal.style.display = 'flex'; // Show modal
            updateUI(); // Update button states as modal is open
        }

        /**
         * Hides the generic modal.
         */
        function hideModal() {
            elements.genericModal.style.display = 'none';
        }

        /**
         * Function to be called after any modal interaction concludes.
         * Handles resuming movement and checking for deferred events.
         */
        function onModalClose() {
            isModalOpen = false; // Clear flag
            updateUI(); // Re-enable buttons

            // Check for any deferred phone calls
            if (deferredCall) {
                console.log("Deferred call detected, triggering after modal close.");
                setTimeout(() => triggerPhoneCall(deferredCall.type, deferredCall.scenario), 500); // Small delay before new call
                deferredCall = null;
            }
            // Check for any deferred job appearances
            if (deferredJobAppearance) {
                console.log("Deferred job appearance detected, triggering after modal close.");
                setTimeout(createNewJob, 500); // Small delay
                deferredJobAppearance = false;
            }
        }

        // --- Game Logic Functions ---

        /**
         * Handles engineer selection.
         */
        function selectEngineer(id) {
            selectedEngineer = id;
            updateUI();
        }

        /**
         * Handles job selection.
         */
        function selectJob(id) {
            selectedJob = id;
            updateUI();
        }

        /**
         * Creates a new job and adds it to the list.
         */
        function createNewJob() {
            if (isModalOpen) {
                deferredJobAppearance = true;
                console.log("New job deferred due to open modal.");
                return;
            }
            const jobNames = ["Pipe Inspection", "Sewer Line Repair", "Drain Unblocking", "Septic Tank Clean-out", "Grease Trap Service", "CCTV Survey"];
            const newJob = {
                id: `job-${jobCounter++}`,
                name: jobNames[getRandomInt(0, jobNames.length - 1)],
                timer: getRandomInt(20, 40), // Time before overdue
                isOverdue: false,
                isAssigned: false
            };
            jobs.push(newJob);
            lastJobAppearanceTime = Date.now();
            updateUI();
            console.log(`New job created: ${newJob.name}`);
        }

        /**
         * Assigns a selected job to a selected engineer.
         */
        function assignJob() {
            if (selectedEngineer && selectedJob) {
                const engineer = engineers.find(e => e.id === selectedEngineer);
                const job = jobs.find(j => j.id === selectedJob);

                if (engineer && job && engineer.isAvailable && !job.isAssigned) {
                    engineer.isAvailable = false;
                    engineer.currentJobId = job.id;
                    job.isAssigned = true;

                    let assignmentEffect = { score: 20, bossPressure: -15 }; // Base effect for successful assignment

                    // Special handling for Jordan and Calum
                    if (engineer.type === 'difficult') { // Jordan
                        assignmentEffect.bossPressure += 5; // Slight increase in Jo's stress
                        assignmentEffect.score -= 5;
                        showModal('Job Assigned', `You assigned ${engineer.name} to "${job.name}". Jordan grumbles but heads out.`, null, onModalClose);
                    } else if (engineer.type === 'nephew') { // Calum
                        showModal('Assign Calum', `You're assigning Calum (Lewis & Mark's relative) to "${job.name}". How do you approach him?`, [
                            { text: 'Firmly: "Calum, this job needs doing now!"', outcome: 'Calum nods curtly. Lewis Trent later approves of your firm hand, but Mark Trent feels you were too harsh on his son.', effect: { score: 15, bossPressure: -10 } },
                            { text: 'Gently: "Hey Calum, think you could take on this one?"', outcome: 'Calum smiles. Mark Trent approves of your gentle approach, but Lewis Trent thinks you\'re too soft.', effect: { score: 10, bossPressure: -5 } }
                        ], onModalClose);
                    } else {
                        showModal('Job Assigned', `You assigned ${engineer.name} to "${job.name}". They head out immediately.`, null, onModalClose);
                    }

                    applyEffect(assignmentEffect);
                    console.log(`Job "${job.name}" assigned to ${engineer.name}.`);

                    // Engineer returns after some time
                    setTimeout(() => {
                        engineer.isAvailable = true;
                        engineer.currentJobId = null;
                        jobs = jobs.filter(j => j.id !== job.id); // Remove completed job
                        updateUI();
                        console.log(`${engineer.name} returned from job.`);
                    }, getRandomInt(8, 15) * 1000); // Engineer returns in 8-15 seconds

                    selectedEngineer = null;
                    selectedJob = null;
                    updateUI();
                } else {
                    console.warn("Attempted to assign job with invalid selection or busy engineer/assigned job.");
                }
            } else {
                console.warn("No engineer or job selected for assignment.");
            }
        }

        /**
         * Clears selected engineer and job.
         */
        function clearSelection() {
            selectedEngineer = null;
            selectedJob = null;
            updateUI();
            console.log("Job assignment selection cleared.");
        }

        let deferredCall = null;
        let deferredJobAppearance = false;

        /**
         * Triggers an incoming phone call based on type and scenario.
         * @param {string} type - 'boss', 'hr', 'asia', 'henryk'
         * @param {object} scenario - The specific call scenario object.
         * @param {string} callerTag - 'asia', 'henryk', 'boss_hr'
         */
        function triggerPhoneCall(type, scenario, callerTag) {
            if (isModalOpen) {
                deferredCall = { type, scenario, callerTag };
                console.log("Phone call deferred due to open modal.");
                return;
            }

            // Update last caller info
            lastCallerType = callerTag;
            consecutiveCallerCount++;

            elements.phoneIcon3D.flashing = true; // Start phone flashing
            console.log("Phone starts ringing visually.");
            updateUI(); // Update 2D phone status icon and button
            lastCallTime = Date.now();
        }

        /**
         * Answers the phone and displays the call modal.
         */
        function answerPhone() {
            elements.phoneIcon3D.flashing = false; // Stop phone flashing
            console.log("Phone answered.");

            let callerType;
            let scenario;

            // Prioritize guaranteed calls
            if (asiaCallsMade < ASIA_CALLS_GUARANTEED && callScenarios.asia.filter(s => !usedAsiaScenarios.has(s.id)).length > 0) {
                scenario = callScenarios.asia.find(s => !usedAsiaScenarios.has(s.id));
                callerType = 'asia';
                asiaCallsMade++;
                usedAsiaScenarios.add(scenario.id);
                console.log(`Asia call (guaranteed ${asiaCallsMade}/${ASIA_CALLS_GUARANTEED})`);
            } else if (henrykCallsMade < HENRYK_CALLS_GUARANTEED && callScenarios.henryk.filter(s => !usedHenrykScenarios.has(s.id)).length > 0) {
                scenario = callScenarios.henryk.find(s => !usedHenrykScenarios.has(s.id));
                callerType = 'henryk';
                henrykCallsMade++;
                usedHenrykScenarios.add(scenario.id);
                console.log(`Henryk call (guaranteed ${henrykCallsMade}/${HENRYK_CALLS_GUARANTEED})`);
            } else {
                // Randomly pick between boss/HR and other personal calls (if any are left)
                const possibleCallers = [];
                if (callScenarios.boss.filter(s => !usedBossScenarios.has(s.id)).length > 0 || callScenarios.hr.filter(s => !usedHRScenarios.has(s.id)).length > 0) {
                    possibleCallers.push('boss_hr');
                }
                if (callScenarios.asia.filter(s => !usedAsiaScenarios.has(s.id)).length > 0 && asiaCallsMade >= ASIA_CALLS_GUARANTEED) {
                    possibleCallers.push('asia');
                }
                if (callScenarios.henryk.filter(s => !usedHenrykScenarios.has(s.id)).length > 0 && henrykCallsMade >= HENRYK_CALLS_GUARANTEED) {
                    possibleCallers.push('henryk');
                }

                // Filter out the last caller type if it was just called, unless it's the only option left
                let availableCallers = possibleCallers.filter(type => type !== lastCallerType || consecutiveCallerCount >= 2); // Allow same caller if 2+ times in a row, or if no other options

                if (availableCallers.length === 0 && possibleCallers.length > 0) {
                    // If filtering removed all, allow the last caller type again as a fallback
                    availableCallers = possibleCallers;
                } else if (availableCallers.length === 0 && possibleCallers.length === 0) {
                    // No calls left
                    showModal('No Calls', 'The line went dead. Must be a wrong number (no scenarios left).', null, onModalClose);
                    return;
                }

                callerType = availableCallers[getRandomInt(0, availableCallers.length - 1)];

                if (callerType === 'hr') { // HR is a sub-type of boss_hr
                    const availableHRS = callScenarios.hr.filter(s => !usedHRScenarios.has(s.id));
                    if (availableHRS.length > 0) {
                        scenario = availableHRS[getRandomInt(0, availableHRS.length - 1)];
                        usedHRScenarios.add(scenario.id);
                        console.log("Random HR call.");
                    } else { // Fallback to generic boss if HR exhausted
                        const availableBossS = callScenarios.boss.filter(s => !usedBossScenarios.has(s.id));
                        if (availableBossS.length > 0) {
                            scenario = availableBossS[getRandomInt(0, availableBossS.length - 1)];
                            usedBossScenarios.add(scenario.id);
                            console.log("Random Boss call (HR exhausted).");
                        }
                    }
                } else if (callerType === 'boss_hr') { // This will pick either boss or HR
                    const bossOrHrScenarios = [
                        ...callScenarios.boss.filter(s => !usedBossScenarios.has(s.id)),
                        ...callScenarios.hr.filter(s => !usedHRScenarios.has(s.id))
                    ];
                    if (bossOrHrScenarios.length > 0) {
                        scenario = bossOrHrScenarios[getRandomInt(0, bossOrHrScenarios.length - 1)];
                        if (callScenarios.boss.some(s => s.id === scenario.id)) {
                             usedBossScenarios.add(scenario.id);
                        } else {
                             usedHRScenarios.add(scenario.id);
                        }
                        console.log("Random Boss/HR call.");
                    }
                } else if (callerType === 'asia') {
                    const availableAsiaS = callScenarios.asia.filter(s => !usedAsiaScenarios.has(s.id));
                    if (availableAsiaS.length > 0) {
                        scenario = availableAsiaS[getRandomInt(0, availableAsiaS.length - 1)];
                        usedAsiaScenarios.add(scenario.id);
                        console.log("Random Asia call.");
                    }
                } else if (callerType === 'henryk') {
                    const availableHenrykS = callScenarios.henryk.filter(s => !usedHenrykScenarios.has(s.id));
                    if (availableHenrykS.length > 0) {
                        scenario = availableHenrykS[getRandomInt(0, availableHenrykS.length - 1)];
                        usedHenrykScenarios.add(scenario.id);
                        console.log("Random Henryk call.");
                    }
                }
            }

            // Reset consecutive counter if caller type changed
            if (callerType !== lastCallerType) {
                consecutiveCallerCount = 0;
            }


            if (scenario) {
                showModal(scenario.caller, scenario.message, scenario.choices);
            } else {
                showModal('No Calls', 'The line went dead. Must be a wrong number (no more unique scenarios).', null, onModalClose);
            }
        }

        /**
         * Handles interaction with Sam.
         */
        function talkToSam() {
            if (isModalOpen) return;
            const availableScenarios = officeScenarios.sam.filter(s => !usedSamScenarios.has(s.id));
            if (availableScenarios.length === 0) {
                showModal('Sam', 'Sam smiles, "Nothing new to talk about today, Jo."', null, onModalClose);
                console.log("No more Sam scenarios.");
                return;
            }
            const scenario = availableScenarios[getRandomInt(0, availableScenarios.length - 1)];
            usedSamScenarios.add(scenario.id);
            showModal('Talk to Sam', scenario.message, scenario.choices);
            console.log("Talking to Sam.");
        }

        /**
         * Handles interaction with Libby.
         */
        function talkToLibby() {
            if (isModalOpen) return;
            const availableScenarios = officeScenarios.libby.filter(s => !usedLibbyScenarios.has(s.id));
            if (availableScenarios.length === 0) {
                showModal('Libby', 'Libby is busy with work right now, Jo.', null, onModalClose);
                console.log("No more Libby scenarios.");
                return;
            }
            const scenario = availableScenarios[getRandomInt(0, availableScenarios.length - 1)];
            usedLibbyScenarios.add(scenario.id);
            showModal('Talk to Libby', scenario.message, scenario.choices);
            console.log("Talking to Libby.");
        }

        /**
         * Function to send game metrics to Google Analytics.
         * @param {string} eventName - The name of the event (e.g., 'game_over', 'high_score').
         * @param {object} params - Object containing event parameters.
         */
        function sendAnalyticsEvent(eventName, params) {
            if (typeof gtag === 'function') {
                gtag('event', eventName, params);
                console.log(`GA Event Sent: ${eventName}`, params);
            } else {
                console.warn("gtag function not available. Google Analytics event not sent.");
            }
        }

        /**
         * Checks for game over conditions.
         */
        function checkGameOver() {
            if (timeLeft <= 0) {
                gameOver('Time\'s Up!', 'You ran out of time! Jo couldn\'t keep up.');
                sendAnalyticsEvent('game_over', { reason: 'time_up', final_score: score });
                return true;
            }
            if (bossPressure >= 100) {
                gameOver('FIRED!', 'Your boss pressure hit 100%! You\'ve been fired from Trent\'s Drains.');
                sendAnalyticsEvent('game_over', { reason: 'fired', final_score: score });
                return true;
            }
            return false;
        }

        /**
         * Ends the game and displays the game over modal or nickname input.
         * @param {string} title
         * @param {string} message
         */
        function gameOver(title, message) {
            gameRunning = false;
            clearInterval(gameInterval);
            clearInterval(jobTimerInterval);
            clearInterval(callTimerInterval);
            jobs.forEach(job => job.intervalId && clearInterval(job.intervalId)); // Clear all job timers if they exist

            elements.gameOverTitle.textContent = title;
            elements.gameOverMessage.textContent = message;

            // Show nickname input modal first
            elements.finalScoreNickname.textContent = score;
            elements.finalAsiaNickname.textContent = asiaHappiness;
            elements.finalSamNickname.textContent = samAttention;
            elements.finalLibbyNickname.textContent = libbyAttention;
            elements.nicknameModal.style.display = 'flex';

            console.log("Game Over! Prompting for nickname.");
        }

        /**
         * Submits nickname and scores to Firestore and then displays leaderboard.
         */
        async function submitNickname() {
            const nickname = elements.nicknameInput.value.trim();
            if (!nickname) {
                elements.nicknameError.style.display = 'block';
                return;
            }
            elements.nicknameError.style.display = 'none';

            elements.nicknameModal.style.display = 'none'; // Hide nickname modal

            const scoreData = {
                score: score,
                asiaScore: asiaHappiness,
                samScore: samAttention,
                libbyScore: libbyAttention
            };

            // Send high score event to Google Analytics
            sendAnalyticsEvent('high_score_submitted', {
                nickname: nickname,
                overall_score: score,
                asia_happiness: asiaHappiness,
                sam_attention: samAttention,
                libby_attention: libbyAttention,
                user_id: window.currentUserId // Include Firebase user ID
            });

            if (window.saveScoreToFirestore) {
                await window.saveScoreToFirestore(nickname, scoreData);
            } else {
                console.warn("Firestore save function not available.");
            }

            // After saving, display the game over modal with leaderboard
            elements.gameOverModal.style.display = 'flex';
            if (window.displayLeaderboard) {
                window.leaderboardInitialized = true; // Flag for Firebase to know it's ready to update
                window.displayLeaderboard();
            } else {
                console.warn("Leaderboard display function not available.");
            }
        }


        /**
         * Restarts the game to initial state.
         */
        function restartGame() {
            console.log("Restarting game...");
            // Reset all game state variables
            timeLeft = 180;
            score = 0;
            bossPressure = 0;
            samAttention = 0;
            libbyAttention = 0;
            asiaHappiness = 50;

            gameRunning = false;
            isModalOpen = false;

            selectedEngineer = null;
            selectedJob = null;

            lastCallTime = 0;
            lastJobAppearanceTime = 0;

            asiaCallsMade = 0;
            henrykCallsMade = 0;

            jobs = [];
            jobCounter = 0;

            usedSamScenarios = new Set();
            usedLibbyScenarios = new Set();
            usedAsiaScenarios = new Set();
            usedHenrykScenarios = new Set();
            usedBossScenarios = new Set();
            usedHRScenarios = new Set();

            // Reset call counters for new game
            lastCallerType = null;
            consecutiveCallerCount = 0;


            engineers.forEach(eng => {
                eng.isAvailable = true;
                eng.currentJobId = null;
            });

            // Reshuffle scenarios for a new game
            callScenarios.boss = shuffleArray(callScenarios.boss.slice());
            callScenarios.hr = shuffleArray(callScenarios.hr.slice());
            callScenarios.asia = shuffleArray(callScenarios.asia.slice());
            callScenarios.henryk = shuffleArray(callScenarios.henryk.slice());
            officeScenarios.sam = shuffleArray(officeScenarios.sam.slice());
            officeScenarios.libby = shuffleArray(officeScenarios.libby.slice());

            elements.gameOverModal.style.display = 'none';
            elements.nicknameModal.style.display = 'none';
            elements.nicknameInput.value = ''; // Clear nickname input
            elements.nicknameError.style.display = 'none'; // Hide error
            elements.startScreen.style.display = 'flex'; // Show start screen again
            elements.gameUI.style.display = 'none'; // Hide game UI

            // Reset intervals and game state
            clearInterval(gameInterval);
            clearInterval(jobTimerInterval);
            clearInterval(callTimerInterval);
            jobs.forEach(job => job.intervalId && clearInterval(job.intervalId)); // Clear all job timers if they exist

            console.log("Game state reset. Ready for new game start via Start Game button.");
            updateUI(); // Update UI for fresh start screen state
        }

        // --- Game Intervals ---
        let gameInterval;
        let jobTimerInterval;
        let callTimerInterval;

        /**
         * Main game loop interval.
         */
        function startGameInterval() {
            if (gameInterval) clearInterval(gameInterval); // Clear existing interval if any
            gameInterval = setInterval(() => {
                if (!gameRunning) return;

                if (!isModalOpen) { // Only decrement time if no modal is open
                    timeLeft--;
                }

                // Update job timers
                jobs.forEach(job => {
                    if (!job.isAssigned) {
                        job.timer--;
                        if (job.timer <= 0 && !job.isOverdue) {
                            job.isOverdue = true;
                            score -= 25; // Penalty for overdue job
                            bossPressure += 20; // Significant boss pressure increase
                            console.log(`Job ${job.name} is overdue!`);
                        }
                    }
                });

                updateUI();
                if (checkGameOver()) {
                    clearInterval(gameInterval);
                }
            }, 1000); // Every second
            console.log("Game interval started.");
        }

        /**
         * Interval for new job appearance.
         */
        function startJobAppearanceInterval() {
            if (jobTimerInterval) clearInterval(jobTimerInterval); // Clear existing interval if any
            jobTimerInterval = setInterval(() => {
                if (!gameRunning) return;
                if (!isModalOpen && (Date.now() - lastJobAppearanceTime) / 1000 >= getRandomInt(15, 25)) { // New job every 15-25 seconds
                    createNewJob();
                }
            }, 1000); // Check every second
            console.log("Job appearance interval started.");
        }

        /**
         * Interval for phone call appearance.
         */
        function startCallInterval() {
            if (callTimerInterval) clearInterval(callTimerInterval); // Clear existing interval if any
            callTimerInterval = setInterval(() => {
                if (!gameRunning) return;
                // Ensure no modal is open and phone is not already ringing
                if (!isModalOpen && !elements.phoneIcon3D.flashing && (Date.now() - lastCallTime) / 1000 >= getRandomInt(8, 20)) {
                    let nextCallerTypeToTrigger = null;
                    let nextScenarioToTrigger = null;

                    const availablePersonalCalls = [];
                    if (asiaCallsMade < ASIA_CALLS_GUARANTEED && callScenarios.asia.filter(s => !usedAsiaScenarios.has(s.id)).length > 0) {
                        availablePersonalCalls.push('asia');
                    }
                    if (henrykCallsMade < HENRYK_CALLS_GUARANTEED && callScenarios.henryk.filter(s => !usedHenrykScenarios.has(s.id)).length > 0) {
                        availablePersonalCalls.push('henryk');
                    }

                    const availableBossHrCalls = [];
                    if (callScenarios.boss.filter(s => !usedBossScenarios.has(s.id)).length > 0) {
                        availableBossHrCalls.push('boss');
                    }
                     if (callScenarios.hr.filter(s => !usedHRScenarios.has(s.id)).length > 0) {
                        availableBossHrCalls.push('hr');
                    }

                    // Priority 1: Guaranteed calls if not exhausted and not the last caller type
                    if (availablePersonalCalls.length > 0 && lastCallerType !== 'personal') {
                        nextCallerTypeToTrigger = availablePersonalCalls[getRandomInt(0, availablePersonalCalls.length - 1)];
                        if (nextCallerTypeToTrigger === 'asia') {
                            nextScenarioToTrigger = callScenarios.asia.find(s => !usedAsiaScenarios.has(s.id));
                        } else { // henryk
                            nextScenarioToTrigger = callScenarios.henryk.find(s => !usedHenrykScenarios.has(s.id));
                        }
                    } else if (availableBossHrCalls.length > 0 && lastCallerType !== 'boss_hr') {
                        nextCallerTypeToTrigger = availableBossHrCalls[getRandomInt(0, availableBossHrCalls.length - 1)];
                         if (nextCallerTypeToTrigger === 'boss') {
                             nextScenarioToTrigger = callScenarios.boss.find(s => !usedBossScenarios.has(s.id));
                         } else { // hr
                             nextScenarioToTrigger = callScenarios.hr.find(s => !usedHRScenarios.has(s.id));
                         }
                    }

                    // Priority 2: If previous attempts failed, try any available call type, even if it's the last one
                    if (!nextScenarioToTrigger) {
                        const allAvailableCallers = [];
                        if (callScenarios.asia.filter(s => !usedAsiaScenarios.has(s.id)).length > 0) allAvailableCallers.push('asia');
                        if (callScenarios.henryk.filter(s => !usedHenrykScenarios.has(s.id)).length > 0) allAvailableCallers.push('henryk');
                        if (callScenarios.boss.filter(s => !usedBossScenarios.has(s.id)).length > 0) allAvailableCallers.push('boss');
                        if (callScenarios.hr.filter(s => !usedHRScenarios.has(s.id)).length > 0) allAvailableCallers.push('hr');

                        if (allAvailableCallers.length > 0) {
                            nextCallerTypeToTrigger = allAvailableCallers[getRandomInt(0, allAvailableCallers.length - 1)];
                            if (nextCallerTypeToTrigger === 'asia') {
                                nextScenarioToTrigger = callScenarios.asia.find(s => !usedAsiaScenarios.has(s.id));
                            } else if (nextCallerTypeToTrigger === 'henryk') {
                                nextScenarioToTrigger = callScenarios.henryk.find(s => !usedHenrykScenarios.has(s.id));
                            } else if (nextCallerTypeToTrigger === 'boss') {
                                nextScenarioToTrigger = callScenarios.boss.find(s => !usedBossScenarios.has(s.id));
                            } else { // hr
                                nextScenarioToTrigger = callScenarios.hr.find(s => !usedHRScenarios.has(s.id));
                            }
                        }
                    }

                    if (nextScenarioToTrigger) {
                        triggerPhoneCall(nextCallerTypeToTrigger, nextScenarioToTrigger, (nextCallerTypeToTrigger === 'asia' || nextCallerTypeToTrigger === 'henryk') ? 'personal' : 'boss_hr');
                    } else {
                        console.log("No unique phone call scenarios left to trigger.");
                        // Optional: trigger generic "no calls" after all unique scenarios are exhausted
                    }
                }
            }, 1000); // Check every second
            console.log("Call interval started.");
        }

        // --- Game Initialization ---
        function initGame() {
            try {
                console.log("Starting game logic...");
                gameRunning = true;
                updateUI();
                startGameInterval();
                startJobAppearanceInterval();
                startCallInterval();
                createNewJob();
                console.log("Game logic started.");
            } catch (error) {
                console.error("Error during initGame:", error);
            }
        }

        // Handle initial "Start Game" button click
        function handleStartGameClick() {
            try {
                console.log("Start Game button clicked. Hiding start screen, showing game UI.");
                if (elements.startScreen) elements.startScreen.style.display = 'none';
                if (elements.gameUI) elements.gameUI.style.display = 'flex'; // Show main game UI

                // Initialize a dummy phoneIcon3D for flashing logic, as it's no longer a 3D object
                elements.phoneIcon3D = { flashing: false };

                initGame(); // Start main game logic
            } catch (error) {
                console.error("Critical error in handleStartGameClick:", error);
            }
        }

    </script>
</body>
</html>
